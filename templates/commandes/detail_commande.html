{% extends "base.html" %} 
{% load static %} 
{% block content %}

<main id="main" class="main">
  <!-- Titre -->
  <div class="pagetitle">
    <h1>Détails de la commande #{{ commande.id }}</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Accueil</a></li>
        <li class="breadcrumb-item">
          <a href="{% url 'liste_commandes' %}">Commandes</a>
        </li>
        <li class="breadcrumb-item active">Détails</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="d-flex justify-content-center">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <!-- En-tête commande -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <h2 class="fw-bold">BON DE LIVRAISON</h2>
                <p><strong>Numéro :</strong> {{ commande.id }}</p>
                <p>
                  <strong>Date :</strong> {{ commande.date_commande|date:"d/m/Y H:i" }}
                </p>
                <p><strong>Statut :</strong> {{ commande.statut }}</p>
              </div>
              <div class="text-end">
                <img
                  src="{% static 'assets/img/MOUNIA_LOGO.png' %}"
                  alt="Logo"
                  style="width: 120px"
                />
                <p><strong>Votre Entreprise</strong></p>
                <p>Adresse</p>
                <p>Téléphone : +212 620-983-827</p>
                <p>Email : contact@exemple.com</p>
              </div>
            </div>

            <!-- Client -->
            <div class="mb-4">
              <h5 class="fw-bold">Informations du client</h5>
              <p><strong>Nom :</strong> {{ commande.client.nom }}</p>
              <p><strong>Adresse :</strong> {{ commande.client.adresse }}</p>
              <p>
                <strong>Téléphone :</strong> {{ commande.client.telephone }}
              </p>
              <p><strong>Email :</strong> {{ commande.client.email }}</p>
              <!-- Prix de livraison spécifique au client -->
              <p><strong>Prix de livraison :</strong> {{ commande.client.prix_livraison|floatformat:2 }} €</p>
            </div>

            <!-- Produits -->
            <h5 class="fw-bold mt-4">Produits commandés</h5>
            <table class="table table-bordered">
              <thead style="background-color: #34b7f1; color: white">
                <tr>
                  <th>Produit</th>
                  <th>Quantité</th>
                  <th>Prix unitaire</th>
                  <th>Sous-total</th>
                </tr>
              </thead>
              <tbody>
                {% for item in commande.items.all %}
                <tr>
                  <td>{{ item.produit.nom }}</td>
                  <td class="text-center">{{ item.quantite }}</td>
                  <td class="text-end">
                    {{ item.prix_unitaire|floatformat:2 }} MAD
                  </td>
                  <td class="text-end">
                    {{ item.sous_total|floatformat:2 }} MAD
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <!-- Totaux -->
            <div class="row justify-content-end">
              <div class="col-md-6">
                <table class="table table-bordered">
                  <tr>
                    <th>Sous-total produits</th>
                    <td class="text-end">{{ commande.total_sans_livraison|floatformat:2 }} MAD</td>
                  </tr>
                  <!-- Ligne ajoutée pour le prix de livraison -->
                  <tr>
                    <th>Frais de livraison</th>
                    <td class="text-end">{{ commande.frais_livraison|floatformat:2 }} €</td>
                  </tr>
                  <!-- Ligne ajoutée pour le total général -->
                  <tr>
                    <th>Total général</th>
                    <td class="text-end fw-bold">
                      {{ commande.total|floatformat:2 }} MAD
                    </td>
                  </tr>
                </table>
              </div>
            </div>

            <!-- Boutons -->
            <div class="d-flex justify-content-between mt-4">
              <a href="{% url 'liste_commandes' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left-circle"></i> Retour
              </a>
              <div>
                <!-- Génération du bon de commande PDF -->
                <a
                  href="{% url 'export_commande_pdf' commande.id %}"
                  class="btn btn-outline-success me-2"
                  target="_blank"
                >
                  <i class="bi bi-file-earmark-pdf"></i> Bon de Livraison
                </a>
                <!-- Envoi du bon de livraison par email -->
                <a
                  href="{% url 'envoyer_bon_livraison_email' commande.id %}"
                  class="btn btn-primary"
                >
                  <i class="bi bi-envelope"></i> Envoyer bon de livraison
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

{% endblock %}