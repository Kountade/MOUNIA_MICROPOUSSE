{% extends "base.html" %} 
{% load static %} 
{% block content %}

<main id="main" class="main">
  <div class="pagetitle">
    <h1>Détails de la commande #{{ commande.id }}</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Accueil</a></li>
        <li class="breadcrumb-item"><a href="{% url 'liste_commandes' %}">Commandes</a></li>
        <li class="breadcrumb-item active">Détails</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="d-flex justify-content-center">
      <div class="col-lg-10">
        <div class="card">
          <div class="card-body">
            <!-- En-tête commande -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <h2 class="fw-bold">BON DE LIVRAISON</h2>
                <p><strong>Numéro :</strong> {{ commande.id }}</p>
                <p><strong>Date :</strong> {{ commande.date_commande|date:"d/m/Y H:i" }}</p>
                <p><strong>Statut :</strong> 
                  <span class="badge 
                    {% if commande.statut == "En cours" %}bg-warning
                    {% elif commande.statut == "Livrée" %}bg-success
                    {% else %}bg-info{% endif %}">
                    {{ commande.statut }}
                  </span>
                </p>
              </div>
              <div class="text-end">
                <img src="{% static 'assets/img/MOUNIA_LOGO.png' %}" alt="Logo" style="width: 120px">
                <p><strong>MOUNIA</strong></p>
                <p>Douar Laarich, 44000 Essaouira</p>
                <p>Téléphone : +212 620-270-420</p>
                <p>Email : mounia.mand97@gmail.com</p>
              </div>
            </div>

            <!-- Client -->
            <div class="mb-4">
              <h5 class="fw-bold">Informations du client</h5>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Nom :</strong> {{ commande.client.nom }}</p>
                  {% if commande.client.ice %}
                  <p><strong>ICE :</strong> {{ commande.client.ice }}</p>
                  {% endif %}
                  {% if commande.client.adresse %}
                  <p><strong>Adresse :</strong> {{ commande.client.adresse }}</p>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  {% if commande.client.telephone %}
                  <p><strong>Téléphone :</strong> {{ commande.client.telephone }}</p>
                  {% endif %}
                  {% if commande.client.email %}
                  <p><strong>Email :</strong> {{ commande.client.email }}</p>
                  {% endif %}
                  <p><strong>Prix de livraison :</strong> {{ commande.client.prix_livraison|floatformat:2 }} MAD</p>
                </div>
              </div>
            </div>

            <!-- Section Remise -->
            <div class="mb-4">
              <h5 class="fw-bold">Gestion des Remises</h5>
              
              <!-- Formulaire d'application de remise -->
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <h6 class="mb-0"><i class="bi bi-percent"></i> Gestion des remises</h6>
                </div>
                <div class="card-body">
                  
                  {% if remise_appliquee %}
                  <!-- Si une remise est déjà appliquée -->
                  <div class="alert alert-warning">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <strong>Remise actuelle:</strong>
                        {% if remise_appliquee.type_remise == 'pourcentage' %}
                          {{ remise_appliquee.valeur_remise }}%
                        {% else %}
                          {{ remise_appliquee.valeur_remise|floatformat:2 }} MAD
                        {% endif %}
                        ({{ remise_appliquee.mois_application }})
                      </div>
                      <button type="button" id="supprimer-remise" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash"></i> Supprimer
                      </button>
                    </div>
                  </div>
                  {% else %}
                  <!-- Formulaire pour appliquer une remise -->
                  <div class="row">
                    <div class="col-md-8">
                      <div class="input-group">
                        <select id="type-remise" class="form-select" style="max-width: 150px;">
                          <option value="pourcentage">Pourcentage %</option>
                          <option value="fixe">Montant fixe</option>
                        </select>
                        <input type="number" id="valeur-remise" class="form-control" placeholder="Valeur" step="0.01" min="0">
                        <button type="button" id="appliquer-remise" class="btn btn-warning">
                          <i class="bi bi-percent"></i> Appliquer
                        </button>
                      </div>
                      <small class="form-text text-muted">
                        La remise sera appliquée pour le mois de {{ commande.date_commande|date:"F Y" }}
                      </small>
                    </div>
                  </div>
                  {% endif %}
                  
                  <div id="message-remise" class="mt-2"></div>
                </div>
              </div>
            </div>

            <!-- Produits -->
            <h5 class="fw-bold mt-4">Produits commandés</h5>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead style="background-color: #34b7f1; color: white">
                  <tr>
                    <th>Produit</th>
                    <th class="text-center">Quantité</th>
                    <th class="text-end">Prix unitaire</th>
                    <th class="text-end">Sous-total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in commande.items.all %}
                  <tr>
                    <td>{{ item.produit.nom }}</td>
                    <td class="text-center">{{ item.quantite }}</td>
                    <td class="text-end">{{ item.prix_unitaire|floatformat:2 }} MAD</td>
                    <td class="text-end">{{ item.sous_total|floatformat:2 }} MAD</td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="4" class="text-center text-muted">Aucun produit dans cette commande</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Totaux -->
            <div class="row justify-content-end mt-4">
              <div class="col-md-6">
                <table class="table table-bordered">
                  <tr>
                    <th>Sous-total produits</th>
                    <td class="text-end">{{ commande.total_sans_livraison|floatformat:2 }} MAD</td>
                  </tr>
                  
                  <!-- Ligne de remise si applicable -->
                  {% if remise_appliquee %}
                  <tr class="table-success">
                    <th>
                      <i class="bi bi-tag"></i> Remise 
                      {% if remise_appliquee.type_remise == 'pourcentage' %}
                        ({{ remise_appliquee.valeur_remise }}%)
                      {% endif %}
                    </th>
                    <td class="text-end text-success fw-bold">
                      -{{ montant_remise|floatformat:2 }} MAD
                    </td>
                  </tr>
                  
                  <!-- Sous-total après remise -->
                  <tr>
                    <th>Sous-total après remise</th>
                    <td class="text-end">
                      {{ commande.total_sans_livraison|floatformat:2|add:"-"|add:montant_remise|floatformat:2 }} MAD
                    </td>
                  </tr>
                  {% endif %}
                  
                  <tr>
                    <th>Frais de livraison</th>
                    <td class="text-end">{{ commande.frais_livraison|floatformat:2 }} MAD</td>
                  </tr>
                  
                  <tr class="table-primary">
                    <th class="fs-6">
                      {% if remise_appliquee %}
                        <strong>Total après remise</strong>
                      {% else %}
                        <strong>Total général</strong>
                      {% endif %}
                    </th>
                    <td class="text-end fs-6 fw-bold">
                      {{ total_avec_remise|floatformat:2 }} MAD
                      {% if remise_appliquee %}
                        <br>
                        <small class="text-muted fs-7">
                          <s>{{ commande.total|floatformat:2 }} MAD</s>
                        </small>
                      {% endif %}
                    </td>
                  </tr>
                  
                  <!-- Économie réalisée -->
                  {% if remise_appliquee %}
                  <tr class="table-warning">
                    <th>Économie réalisée</th>
                    <td class="text-end fw-bold text-warning">
                      {{ montant_remise|floatformat:2 }} MAD
                    </td>
                  </tr>
                  {% endif %}
                </table>
              </div>
            </div>

            <!-- Notes de commande -->
            {% if commande.notes %}
            <div class="mt-4">
              <h5 class="fw-bold">Notes internes</h5>
              <div class="card bg-light">
                <div class="card-body">
                  <p class="mb-0">{{ commande.notes }}</p>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Boutons d'action -->
            <div class="d-flex justify-content-between mt-4 pt-4 border-top">
              <div>
                <a href="{% url 'liste_commandes' %}" class="btn btn-secondary">
                  <i class="bi bi-arrow-left-circle"></i> Retour
                </a>
                {% if commande.statut == "En cours" %}
                <a href="{% url 'modifier_commande' commande.id %}" class="btn btn-outline-primary ms-2">
                  <i class="bi bi-pencil"></i> Modifier
                </a>
                {% endif %}
              </div>
              <div>
                <!-- Bouton Dupliquer -->
                <a href="{% url 'dupliquer_commande' commande.id %}" class="btn btn-info me-2">
                  <i class="bi bi-copy"></i> Dupliquer Commande
                </a>
                <!-- Génération du bon de commande PDF -->
                <a href="{% url 'export_commande_bon_pdf' commande.id %}" 
                   class="btn btn-outline-success me-2" target="_blank">
                  <i class="bi bi-file-earmark-pdf"></i> Bon de Livraison
                </a>
                <!-- Envoi du bon de livraison par email -->
                <a href="{% url 'envoyer_bon_livraison_email' commande.id %}" class="btn btn-primary">
                  <i class="bi bi-envelope"></i> Envoyer bon de livraison
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- JavaScript pour la remise -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnRemise = document.getElementById('appliquer-remise');
    const btnSupprimerRemise = document.getElementById('supprimer-remise');
    const messageRemise = document.getElementById('message-remise');
    const typeRemiseSelect = document.getElementById('type-remise');
    const valeurRemiseInput = document.getElementById('valeur-remise');
    
    // Fonction pour appliquer une remise
    if (btnRemise) {
        btnRemise.addEventListener('click', function() {
            const typeRemise = typeRemiseSelect.value;
            const valeurRemise = valeurRemiseInput.value;
            
            // Validation
            if (!valeurRemise || parseFloat(valeurRemise) <= 0) {
                showMessage('Veuillez entrer une valeur valide positive', 'danger');
                return;
            }
            
            if (typeRemise === 'pourcentage' && parseFloat(valeurRemise) > 100) {
                showMessage('Le pourcentage ne peut pas dépasser 100%', 'danger');
                return;
            }
            
            // Préparation des données
            const data = {
                type_remise: typeRemise,
                valeur_remise: parseFloat(valeurRemise)
            };
            
            // Indicateur de chargement
            btnRemise.disabled = true;
            btnRemise.innerHTML = '<i class="bi bi-hourglass-split"></i> Application...';
            
            // Envoi de la requête
            fetch(`/commande/{{ commande.id }}/appliquer-remise-commande/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    let messageHtml = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <strong>Succès!</strong> ${data.message}
                    `;
                    
                    if (data.total_avec_remise) {
                        messageHtml += `<br><strong>Nouveau total:</strong> ${data.total_avec_remise} MAD`;
                    }
                    if (data.montant_remise) {
                        messageHtml += `<br><strong>Montant de la remise:</strong> ${data.montant_remise} MAD`;
                    }
                    
                    messageHtml += `
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    
                    messageRemise.innerHTML = messageHtml;
                    valeurRemiseInput.value = '';
                    
                    // Recharger la page après 1.5 secondes
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                    
                } else {
                    showMessage(data.message || 'Erreur inconnue', 'danger');
                }
            })
            .catch(error => {
                console.error('Erreur fetch:', error);
                showMessage('Erreur de communication avec le serveur: ' + error.message, 'danger');
            })
            .finally(() => {
                btnRemise.disabled = false;
                btnRemise.innerHTML = '<i class="bi bi-percent"></i> Appliquer';
            });
        });
    }
    
    // Fonction pour supprimer une remise
    if (btnSupprimerRemise) {
        btnSupprimerRemise.addEventListener('click', function() {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette remise ?')) {
                return;
            }
            
            // Indicateur de chargement
            btnSupprimerRemise.disabled = true;
            btnSupprimerRemise.innerHTML = '<i class="bi bi-hourglass-split"></i> Suppression...';
            
            // Envoi de la requête
            fetch(`/commande/{{ commande.id }}/supprimer-remise-commande/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    
                    // Recharger la page après 1.5 secondes
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                    
                } else {
                    showMessage(data.message || 'Erreur inconnue', 'danger');
                }
            })
            .catch(error => {
                console.error('Erreur fetch:', error);
                showMessage('Erreur de communication avec le serveur: ' + error.message, 'danger');
            })
            .finally(() => {
                btnSupprimerRemise.disabled = false;
                btnSupprimerRemise.innerHTML = '<i class="bi bi-trash"></i> Supprimer';
            });
        });
    }
    
    function showMessage(message, type) {
        messageRemise.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
    
    // Gestion de la touche Entrée
    if (valeurRemiseInput) {
        valeurRemiseInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                btnRemise.click();
            }
        });
    }
    
    // Aide contextuelle
    if (typeRemiseSelect) {
        typeRemiseSelect.addEventListener('change', function() {
            if (this.value === 'pourcentage') {
                valeurRemiseInput.placeholder = 'Ex: 10 pour 10%';
                valeurRemiseInput.max = '100';
            } else {
                valeurRemiseInput.placeholder = 'Ex: 50 pour 50 MAD';
                valeurRemiseInput.removeAttribute('max');
            }
        });
        
        // Initialiser le placeholder
        typeRemiseSelect.dispatchEvent(new Event('change'));
    }
});
</script>

<style>
.card-header.bg-light {
    background-color: #f8f9fa !important;
    border-bottom: 1px solid #dee2e6;
}
.table th {
    background-color: #2c3e50;
    color: white;
}
.badge {
    font-size: 0.75em;
}
.fs-6 {
    font-size: 1.1rem !important;
}
.fs-7 {
    font-size: 0.9rem !important;
}
.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
}
.btn-warning {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
}
.btn-warning:hover {
    background-color: #e0a800;
    border-color: #d39e00;
}
</style>

{% endblock %}