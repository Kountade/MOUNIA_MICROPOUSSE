{% extends "base.html" %} {% load static %} {% block content %}
<div class="container">
  <div class="page-inner">
    <div
      class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4"
    >
      <div>
        <h3 class="fw-bold mb-3">Dashboard</h3>
        <h6 class="op-7 mb-2">
          {% if parametres.logo %}
          <img
            src="{{ parametres.logo.url }}"
            alt="Logo {{ parametres.nom_hotel }}"
            style="height: 30px"
            class="me-2"
          />
          {% endif %} {{ parametres.nom_hotel|default:"Mon Hôtel" }}
        </h6>

        <!-- Messages flash -->
        {% if messages %}
        <div class="messages-container mt-3">
          {% for message in messages %}
          <div
            class="alert alert-{{ message.tags }} alert-dismissible fade show"
            role="alert"
          >
            <div class="d-flex align-items-center">
              {% if message.tags == 'success' %}
              <i class="fas fa-check-circle me-2"></i>
              {% elif message.tags == 'error' or message.tags == 'danger' %}
              <i class="fas fa-exclamation-circle me-2"></i>
              {% elif message.tags == 'warning' %}
              <i class="fas fa-exclamation-triangle me-2"></i>
              {% elif message.tags == 'info' %}
              <i class="fas fa-info-circle me-2"></i>
              {% endif %}
              <span>{{ message }}</span>
            </div>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      <div class="ms-md-auto py-2 py-md-0">
        <a href="#" class="btn btn-label-info btn-round me-2">Manage</a>
        <a href="{% url 'creer_commande'%}" class="btn btn-primary btn-round"
          >Nouvelle Commande</a
        >
      </div>
    </div>

    <!-- Cartes Statistiques Rapides -->
    <div class="row">
      <!-- Carte 1: Nombre total de clients -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-round">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-icon">
                <div
                  class="icon-big text-center icon-primary bubble-shadow-small"
                >
                  <i class="fas fa-users"></i>
                </div>
              </div>
              <div class="col col-stats ms-3 ms-sm-0">
                <div class="numbers">
                  <p class="card-category">Total Clients</p>
                  <h4 class="card-title">{{ stats_rapides.total_clients }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Carte 2: Clients ce mois -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-round">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-icon">
                <div class="icon-big text-center icon-info bubble-shadow-small">
                  <i class="fas fa-user-plus"></i>
                </div>
              </div>
              <div class="col col-stats ms-3 ms-sm-0">
                <div class="numbers">
                  <p class="card-category">Clients ce mois</p>
                  <h4 class="card-title">
                    {{ stats_rapides.clients_ce_mois }}
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Carte 3: Total produits -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-round">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-icon">
                <div
                  class="icon-big text-center icon-success bubble-shadow-small"
                >
                  <i class="fas fa-box"></i>
                </div>
              </div>
              <div class="col col-stats ms-3 ms-sm-0">
                <div class="numbers">
                  <p class="card-category">Total Produits</p>
                  <h4 class="card-title">{{ stats_rapides.total_produits }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Carte 4: Prix moyen -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-round">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-icon">
                <div
                  class="icon-big text-center icon-secondary bubble-shadow-small"
                >
                  <i class="fas fa-money-bill-wave"></i>
                </div>
              </div>
              <div class="col col-stats ms-3 ms-sm-0">
                <div class="numbers">
                  <p class="card-category">Prix Moyen</p>
                  <h4 class="card-title">
                    {{ stats_rapides.prix_moyen_produits }} MAD
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Deuxième ligne de cartes -->
    <div class="row mt-3">
      <!-- Carte 5: Total Commandes -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-round">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-icon">
                <div
                  class="icon-big text-center icon-warning bubble-shadow-small"
                >
                  <i class="fas fa-shopping-cart"></i>
                </div>
              </div>
              <div class="col col-stats ms-3 ms-sm-0">
                <div class="numbers">
                  <p class="card-category">Total Commandes</p>
                  <h4 class="card-title">
                    {{ stats_rapides.total_commandes }}
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Carte 6: CA Total -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-round">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-icon">
                <div
                  class="icon-big text-center icon-success bubble-shadow-small"
                >
                  <i class="fas fa-chart-line"></i>
                </div>
              </div>
              <div class="col col-stats ms-3 ms-sm-0">
                <div class="numbers">
                  <p class="card-category">CA Total</p>
                  <h4 class="card-title">
                    {{ stats_rapides.ca_total|floatformat:2 }} MAD
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Carte 7: CA Ce Mois -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-round">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-icon">
                <div class="icon-big text-center icon-info bubble-shadow-small">
                  <i class="fas fa-calendar-alt"></i>
                </div>
              </div>
              <div class="col col-stats ms-3 ms-sm-0">
                <div class="numbers">
                  <p class="card-category">CA Ce Mois</p>
                  <h4 class="card-title">
                    {{ stats_rapides.ca_ce_mois|floatformat:2 }} MAD
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Carte 8: Commandes Cette Semaine -->
      <div class="col-sm-6 col-md-3">
        <div class="card card-stats card-round">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-icon">
                <div
                  class="icon-big text-center icon-primary bubble-shadow-small"
                >
                  <i class="fas fa-rocket"></i>
                </div>
              </div>
              <div class="col col-stats ms-3 ms-sm-0">
                <div class="numbers">
                  <p class="card-category">Cmd Cette Semaine</p>
                  <h4 class="card-title">
                    {{ stats_rapides.commandes_cette_semaine }}
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Graphiques Principaux -->
    <div class="row mt-4">
      <!-- Graphique Évolution du CA -->
      <div class="col-md-6">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Chiffre d'Affaires Mensuel</div>
            </div>
          </div>
          <div class="card-body">
            <canvas id="caChart" height="250"></canvas>
          </div>
        </div>
      </div>

      <!-- Graphique Commandes par Ville -->
      <div class="col-md-6">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Répartition des Commandes par Ville</div>
            </div>
          </div>
          <div class="card-body">
            {% if commandes_ville_chart %}
            <canvas id="commandesVilleChart" height="250"></canvas>
            {% else %}
            <div class="text-center text-muted py-4">
              <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
              <p>Aucune donnée de commandes par ville disponible</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <!-- Graphique Évolution Commandes -->
      <div class="col-md-8">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Évolution des Commandes et CA</div>
            </div>
          </div>
          <div class="card-body">
            <canvas id="commandesChart" height="300"></canvas>
          </div>
        </div>
      </div>

      <!-- Sidebar avec Top Clients et Produits -->
      <div class="col-md-4">
        <!-- Top Clients -->
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Top 5 Clients</div>
            </div>
          </div>
          <div class="card-body">
            <div class="list-group">
              {% for client in top_clients|slice:":5" %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1">{{ client.nom }}</h6>
                    <small class="text-muted">{{ client.ville }}</small>
                  </div>
                  <div class="text-end">
                    <strong>{{ client.total_ca|floatformat:2 }} MAD</strong>
                    <br />
                    <small class="text-muted"
                      >{{ client.total_commandes }} cmd</small
                    >
                  </div>
                </div>
              </div>
              {% empty %}
              <div class="text-center text-muted py-3">Aucune donnée</div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Top Produits -->
        <div class="card card-round mt-4">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Top 5 Produits</div>
            </div>
          </div>
          <div class="card-body">
            <div class="list-group">
              {% for produit in top_produits|slice:":5" %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1">{{ produit.nom }}</h6>
                    <small class="text-muted">{{ produit.prix }} MAD</small>
                  </div>
                  <span class="badge badge-primary"
                    >{{ produit.total_commandes }} ventes</span
                  >
                </div>
              </div>
              {% empty %}
              <div class="text-center text-muted py-3">Aucune donnée</div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tableaux détaillés -->
    <div class="row mt-4">
      <div class="col-md-8">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Évolution des Clients</div>
              <div class="card-tools">
                <a href="#" class="btn btn-label-success btn-round btn-sm me-2">
                  <span class="btn-label">
                    <i class="fa fa-pencil"></i>
                  </span>
                  Export
                </a>
                <a href="#" class="btn btn-label-info btn-round btn-sm">
                  <span class="btn-label">
                    <i class="fa fa-print"></i>
                  </span>
                  Print
                </a>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Tableau d'évolution des clients -->
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Mois</th>
                    <th>Nouveaux Clients</th>
                    <th>Tendance</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in evolution_clients %}
                  <tr>
                    <td>{{ item.mois|date:"F Y" }}</td>
                    <td>{{ item.total }}</td>
                    <td>
                      {% if item.total > 0 %}
                      <span class="badge badge-success">↑</span>
                      {% else %}
                      <span class="badge badge-secondary">-</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="3" class="text-center">
                      Aucune donnée disponible
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <!-- Carte répartition par ville -->
        <div class="card card-primary card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Clients par Ville</div>
              <div class="card-tools">
                <div class="dropdown">
                  <button
                    class="btn btn-sm btn-label-light dropdown-toggle"
                    type="button"
                    id="dropdownMenuButton"
                    data-bs-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false"
                  >
                    Actions
                  </button>
                  <div
                    class="dropdown-menu"
                    aria-labelledby="dropdownMenuButton"
                  >
                    <a class="dropdown-item" href="#">Voir tout</a>
                    <a class="dropdown-item" href="#">Exporter</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-4 mt-2">
              <h4>{{ stats_rapides.total_clients }} Clients</h4>
            </div>
            <div class="list-group">
              {% for item in clients_par_ville|slice:":5" %}
              <div
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                {{ item.ville }}
                <span class="badge badge-primary badge-pill"
                  >{{ item.total }}</span
                >
              </div>
              {% empty %}
              <div class="list-group-item text-center text-muted">
                Aucune donnée
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Carte produits actifs -->
        <div class="card card-round mt-4">
          <div class="card-body pb-0">
            <div class="h1 fw-bold float-end text-success">
              {{ stats_rapides.produits_actifs }}
            </div>
            <h2 class="mb-2">Produits Actifs</h2>
            <p class="text-muted">
              Sur {{ stats_rapides.total_produits }} total
            </p>
            <div class="progress mb-3">
              <div
                class="progress-bar bg-success"
                role="progressbar"
                style="width: {% widthratio stats_rapides.produits_actifs stats_rapides.total_produits 100 %}%"
                aria-valuenow="{% widthratio stats_rapides.produits_actifs stats_rapides.total_produits 100 %}"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Messages flash
    const alerts = document.querySelectorAll(".alert");
    alerts.forEach((alert) => {
      setTimeout(() => {
        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
        bsAlert.close();
      }, 3000);
    });

    // Données des graphiques depuis le contexte Django
    const caMensuelData = {{ ca_mensuel|safe }};
    const commandesVilleData = {{ commandes_ville_chart|safe }};
    const commandesEvolutionData = {{ commandes_evolution|safe }};
    const statutsCommandesData = {{ statuts_commandes|safe }};

    console.log("📊 Données graphiques chargées:", {
      caMensuel: caMensuelData,
      commandesVille: commandesVilleData,
      evolutionCommandes: commandesEvolutionData,
      statutsCommandes: statutsCommandesData
    });

    // Graphique CA Mensuel
    if (document.getElementById("caChart") && caMensuelData.mois.length > 0) {
      const caCtx = document.getElementById("caChart").getContext("2d");
      const caChart = new Chart(caCtx, {
        type: "bar",
        data: {
          labels: caMensuelData.mois,
          datasets: [
            {
              label: "Chiffre d'Affaires (MAD)",
              data: caMensuelData.montants,
              backgroundColor: "rgba(54, 162, 235, 0.5)",
              borderColor: "rgba(54, 162, 235, 1)",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function (value) {
                  return value + " MAD";
                },
              },
            },
          },
        },
      });
    } else {
      console.log("Aucune donnée pour le graphique CA Mensuel");
    }

    // Graphique Commandes par Ville
    if (document.getElementById("commandesVilleChart") && commandesVilleData.labels.length > 0) {
      const commandesVilleCtx = document.getElementById("commandesVilleChart").getContext("2d");
      const commandesVilleChart = new Chart(commandesVilleCtx, {
        type: "doughnut",
        data: {
          labels: commandesVilleData.labels,
          datasets: [{
            data: commandesVilleData.data,
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)',
              'rgba(199, 199, 199, 0.7)',
              'rgba(83, 102, 255, 0.7)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 159, 64, 1)',
              'rgba(199, 199, 199, 1)',
              'rgba(83, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} commandes (${percentage}%)`;
                }
              }
            }
          }
        },
      });
    } else {
      console.log("Aucune donnée pour le graphique Commandes par Ville");
    }

    // Graphique Évolution Commandes et CA
    if (document.getElementById("commandesChart") && commandesEvolutionData.semaines.length > 0) {
      const commandesCtx = document.getElementById("commandesChart").getContext("2d");
      const commandesChart = new Chart(commandesCtx, {
        type: "line",
        data: {
          labels: commandesEvolutionData.semaines,
          datasets: [
            {
              label: "Nombre de Commandes",
              data: commandesEvolutionData.commandes,
              borderColor: "rgba(54, 162, 235, 1)",
              backgroundColor: "rgba(54, 162, 235, 0.1)",
              yAxisID: "y",
              tension: 0.4,
            },
            {
              label: "Chiffre d'Affaires (MAD)",
              data: commandesEvolutionData.ca,
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.1)",
              yAxisID: "y1",
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          interaction: {
            mode: "index",
            intersect: false,
          },
          scales: {
            y: {
              type: "linear",
              display: true,
              position: "left",
              title: {
                display: true,
                text: "Nombre de Commandes",
              },
            },
            y1: {
              type: "linear",
              display: true,
              position: "right",
              title: {
                display: true,
                text: "Chiffre d'Affaires (MAD)",
              },
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                callback: function (value) {
                  return value + " MAD";
                },
              },
            },
          },
        },
      });
    } else {
      console.log("Aucune donnée pour le graphique Évolution Commandes");
    }

    // Graphique Statuts des Commandes (optionnel)
    if (statutsCommandesData.labels.length > 0) {
      console.log("Données statuts commandes disponibles:", statutsCommandesData);
    }
  });
</script>

{% endblock content %}
