{% extends "base.html" %} 
{% load static %} 
{% block content %}
<div class="container">
    <div class="page-inner">
        <div class="page-header">
            <h3 class="fw-bold mb-3">Génération des Factures Mensuelles</h3>
            <ul class="breadcrumbs mb-3">
                <li class="nav-home">
                    <a href="{% url 'home' %}">
                        <i class="icon-home"></i>
                    </a>
                </li>
                <li class="separator">
                    <i class="icon-arrow-right"></i>
                </li>
                <li class="nav-item">
                    <a href="{% url 'liste_factures' %}">Factures</a>
                </li>
                {% if client_selected or mois_selected %}
                <li class="separator">
                    <i class="icon-arrow-right"></i>
                </li>
                <li class="nav-item">
                    <span>Filtres actifs</span>
                </li>
                {% endif %}
            </ul>
        </div>

        <!-- Messages -->
        {% if messages %} 
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
            {% endfor %} 
        {% endif %}

        <!-- Formulaire de filtres -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title"><i class="bi bi-funnel"></i> Filtres pour générer une facture mensuelle</h5>
            </div>
            <div class="card-body">
                <form method="get" action="{% url 'liste_factures' %}">
                    <div class="row">
                        <!-- Filtre par client -->
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="client" class="form-label fw-bold">Client :</label>
                                <select name="client" id="client" class="form-control" required>
                                    <option value="">Sélectionnez un client</option>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}" 
                                        {% if client_selected and client_selected.id == client.id %}selected{% endif %}>
                                        {{ client.nom }} - {{ client.ville }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Filtre par mois -->
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="mois" class="form-label fw-bold">Mois :</label>
                                <select name="mois" id="mois" class="form-control" required>
                                    <option value="">Sélectionnez un mois</option>
                                    {% for mois in mois_disponibles %}
                                    <option value="{{ mois.value }}" 
                                        {% if mois_selected == mois.value %}selected{% endif %}>
                                        {{ mois.label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Boutons -->
                        <div class="col-md-2">
                            <div class="form-group" style="margin-top: 30px;">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-search"></i> Filtrer
                                </button>
                                <a href="{% url 'liste_factures' %}" class="btn btn-outline-secondary w-100 mt-2">
                                    <i class="bi bi-arrow-clockwise"></i> Reset
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- NOUVELLE SECTION AVEC RÉDUCTIONS INTÉGRÉE -->
        <!-- ========================================= -->
        {% if client_selected and mois_selected %}
        <div class="alert alert-success">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-1">
                        <i class="bi bi-file-text"></i> 
                        Facture mensuelle pour <strong>{{ client_selected.nom }}</strong> 
                        - <strong>{{ mois_obj|date:"F Y" }}</strong>
                    </h5>
                    <p class="mb-0">
                        {{ commandes|length }} commande(s) trouvée(s)
                    </p>
                    <div class="mt-2">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <td>Total HT:</td>
                                <td class="text-end"><strong>{{ total_mois|floatformat:2 }} MAD</strong></td>
                            </tr>
                            {% if remise_appliquee > 0 %}
                            <tr class="text-success">
                                <td>Remise appliquée:</td>
                                <td class="text-end"><strong>-{{ remise_appliquee|floatformat:2 }} MAD</strong></td>
                            </tr>
                            {% endif %}
                            <tr class="fw-bold">
                                <td>Total après remise:</td>
                                <td class="text-end">{{ total_apres_remise|floatformat:2 }} MAD</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{% url 'facture_client_mois_pdf' %}?client={{ client_selected.id }}&mois={{ mois_selected }}" 
                       class="btn btn-danger btn-lg mb-2">
                        <i class="bi bi-file-earmark-pdf"></i> Générer la Facture PDF
                    </a>
                    <br>
                    <a href="{% url 'appliquer_remise' client_selected.id mois_selected %}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-percent"></i> Gérer la remise
                    </a>
                </div>
            </div>
        </div>
        {% elif client_selected or mois_selected %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            Veuillez sélectionner à la fois un client et un mois pour générer une facture.
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Sélectionnez un client et un mois pour afficher les commandes et générer une facture mensuelle.
        </div>
        {% endif %}

        <!-- Tableau des commandes -->
        {% if client_selected and mois_selected %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="bi bi-list-ul"></i> Détail des commandes
                    <span class="badge bg-primary ms-2">{{ commandes|length }} commande(s)</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="commandes-table" class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>N° Commande</th>
                                <th>Date</th>
                                <th>Produits</th>
                                <th>Quantité Totale</th>
                                <th>Statut</th>
                                <th>Total (MAD)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for commande in commandes %}
                            <tr>
                                <td><strong>#{{ commande.id }}</strong></td>
                                <td>{{ commande.date_commande|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <small>
                                        {% for item in commande.items.all %}
                                        • {{ item.produit.nom }}<br>
                                        {% endfor %}
                                    </small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ commande.items.count }} produit(s)
                                    </span>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if commande.statut == "En cours" %}bg-warning text-dark
                                        {% elif commande.statut == "Livrée" %}bg-success
                                        {% else %}bg-info{% endif %}">
                                        {{ commande.statut }}
                                    </span>
                                </td>
                                <td>
                                    <strong>{{ commande.total|floatformat:2 }} MAD</strong>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'detail_commande' commande.id %}" 
                                           class="btn btn-outline-info" 
                                           title="Voir les détails">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{% url 'modifier_commande' commande.pk %}" 
                                           class="btn btn-outline-primary" 
                                           title="Modifier">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                        <br>
                                        <p class="mt-2">Aucune commande trouvée pour {{ client_selected.nom }} 
                                        au mois de {{ mois_obj|date:"F Y" }}.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        {% if commandes %}
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="5" class="text-end fw-bold">
                                    {% if remise_appliquee > 0 %}
                                        Total après remise :
                                    {% else %}
                                        Total du mois :
                                    {% endif %}
                                </td>
                                <td class="fw-bold">
                                    {% if remise_appliquee > 0 %}
                                        {{ total_apres_remise|floatformat:2 }} MAD
                                    {% else %}
                                        {{ total_mois|floatformat:2 }} MAD
                                    {% endif %}
                                </td>
                                <td></td>
                            </tr>
                            {% if remise_appliquee > 0 %}
                            <tr class="text-success">
                                <td colspan="5" class="text-end fw-bold">Économie réalisée :</td>
                                <td class="fw-bold">-{{ remise_appliquee|floatformat:2 }} MAD</td>
                                <td></td>
                            </tr>
                            {% endif %}
                        </tfoot>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser DataTable si le tableau existe
    const table = document.getElementById('commandes-table');
    if (table) {
        $('#commandes-table').DataTable({
            pageLength: 10,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json'
            },
            order: [[1, 'desc']], // Tri par date décroissante
            responsive: true,
            dom: '<"top"f>rt<"bottom"lip><"clear">'
        });
    }
    
    // Validation du formulaire
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const client = document.getElementById('client').value;
        const mois = document.getElementById('mois').value;
        
        if (!client || !mois) {
            e.preventDefault();
            alert('Veuillez sélectionner un client et un mois.');
        }
    });
});
</script>

<style>
.card-header.bg-primary {
    background: linear-gradient(45deg, #0d6efd, #0a58ca);
}
.table th {
    background-color: #2c3e50;
    color: white;
}
.badge {
    font-size: 0.75em;
}
.table-borderless td {
    border: none !important;
}
.text-success {
    color: #198754 !important;
}
</style>
{% endblock content %}